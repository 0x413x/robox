{
  "variables": {
    "box_version": "{{env `VERSION`}}"
  },
  "provisioners": [
    {
      "scripts": [
        "scripts/gentoo/install-alt.sh"
      ],
      "type": "shell",
      "start_retry_timeout": "15m",
      "expect_disconnect": "true",
      "only": ["magma-gentoo-vmware"]
    }
  ],
  "builders": [
    {
      "type": "vmware-iso",
      "name": "magma-gentoo-vmware",
      "vm_name": "magma-gentoo-vmware",
      "vmdk_name": "magma-gentoo-vmware",
      "output_directory": "output/magma-gentoo-vmware",
      "boot_wait": "5s",
      "boot_command": [
        "gentoo-nofb<enter>",
        "<wait10><enter>",
        "<wait10><wait10><wait10><wait10><wait10><wait10>",
        "passwd root<enter><wait>",
        "vagrant<enter><wait>",
        "vagrant<enter><wait>",
        "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config<enter><wait>",
        "echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config<enter><wait>",
        "/etc/init.d/sshd start<enter><wait>"
      ],
      "disk_size": 32768,
      "disk_type_id": "0",
      "vmx_data": {
            "memsize": "2048",
            "numvcpus": "2",
            "cpuid.coresPerSocket": "1"
      },
      "guest_os_type": "otherlinux-64",
      "skip_compaction": false,
      "headless": true,
      "iso_url": "https://mirrors.kernel.org/gentoo/releases/amd64/autobuilds/20161208/install-amd64-minimal-20161208.iso",
      "iso_checksum": "27791ea5d3e6ef138f411083545af1d30622551a60dac42a9afaeaaa987c1d77",
      "iso_checksum_type": "sha256",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "shutdown -hP now",
      "tools_upload_flavor": "linux"

    },
    {
      "type": "vmware-iso",
      "name": "magma-freebsd11-vmware",
      "vm_name": "magma-freebsd11-vmware",
      "vmdk_name": "magma-freebsd11-vmware",
      "output_directory": "output/magma-freebsd11-vmware",
      "boot_wait": "5s",
      "boot_command": [
        "<esc><wait>",
        "boot -s<wait>",
        "<enter><wait>",
        "<wait10><wait10>",
        "/bin/sh<enter><wait>",
        "mdmfs -s 100m md1 /tmp<enter><wait>",
        "mdmfs -s 100m md2 /mnt<enter><wait>",
        "dhclient -l /tmp/dhclient.lease.em0 em0<enter><wait5>",
        "fetch -o /tmp/installerconfig http://{{ .HTTPIP }}:{{ .HTTPPort }}/magma.freebsd11.vagrant.cfg<enter><wait5>",
        "bsdinstall script /tmp/installerconfig && reboot<enter><wait>"
      ],
      "disk_size": 32768,
      "disk_type_id": "0",
      "vmx_data": {
            "memsize": "2048",
            "numvcpus": "2",
            "cpuid.coresPerSocket": "1"
      },
      "guest_os_type": "freeBSD-64",
      "skip_compaction": false,
      "http_directory": "http",
      "headless": true,
      "iso_url": "https://download.freebsd.org/ftp/releases/ISO-IMAGES/11.0/FreeBSD-11.0-RELEASE-amd64-disc1.iso",
      "iso_checksum": "08b12f2dc378f7a61b5469219824c74a2f9faef580acc85ffab45365df79872d",
      "iso_checksum_type": "sha256",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "shutdown -p now",
      "tools_upload_flavor": "freebsd"

    },
    {
      "type": "vmware-iso",
      "name": "magma-openbsd6-vmware",
      "vm_name": "magma-openbsd6-vmware",
      "vmdk_name": "magma-openbsd6-vmware",
      "output_directory": "output/magma-openbsd6-vmware",
      "boot_wait": "20s",
      "boot_command": [
        "S<enter><wait>",
        "dhclient em0<enter><wait5>",
        "ftp -o /install.conf http://{{.HTTPIP}}:{{.HTTPPort}}/magma.openbsd6.install.cfg<enter><wait>",
        "ftp -o /install-chroot.sh http://{{.HTTPIP}}:{{.HTTPPort}}/magma.openbsd6.install.chroot.sh<enter><wait>",
        "/install -a -f /install.conf && chroot /mnt < /install-chroot.sh && reboot<enter>"
      ],
      "disk_size": 32768,
      "disk_type_id": "0",
      "vmx_data": {
            "memsize": "2048",
            "numvcpus": "2",
            "cpuid.coresPerSocket": "1"
      },
      "guest_os_type": "freeBSD-64",
      "skip_compaction": false,
      "http_directory": "http",
      "headless": true,
      "iso_url": "https://mirror.math.princeton.edu/pub/OpenBSD/6.0/amd64/cd60.iso",
      "iso_checksum": "fe1006fb002cb14e561cddf910ba57e0f785c47ff6b04818b0767373b3145e6e",
      "iso_checksum_type": "sha256",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "shutdown -h -p now",
      "tools_upload_flavor": "freebsd"

    },
    {
      "type": "vmware-iso",
      "name": "magma-arch-vmware",
      "vm_name": "magma-arch-vmware",
      "vmdk_name": "magma-arch-vmware",
      "output_directory": "output/magma-arch-vmware",
      "boot_wait": "20s",
      "boot_command": [
        "<enter><wait10><wait10><wait10>",
        "curl -O 'http://{{.HTTPIP}}:{{.HTTPPort}}/arch.install{,.chroot}.sh'<enter><wait>",
        "bash arch.install.sh < arch.install.chroot.sh && systemctl reboot<enter>"
      ],
      "disk_size": 32768,
      "disk_type_id": "0",
      "vmx_data": {
            "memsize": "2048",
            "numvcpus": "2",
            "cpuid.coresPerSocket": "1"
      },
      "guest_os_type": "otherlinux-64",
      "skip_compaction": false,
      "http_directory": "http",
      "headless": true,
      "iso_url": "https://mirrors.kernel.org/archlinux/iso/2016.12.01/archlinux-2016.12.01-dual.iso",
      "iso_checksum": "d3ae695429cfbdc4363ff3be27345332220cf0deb0f55705fa19ec9669ae6a13",
      "iso_checksum_type": "sha256",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
      "tools_upload_flavor": "linux"

    },
    {
      "type": "vmware-iso",
      "name": "magma-fedora25-vmware",
      "vm_name": "magma-fedora25-vmware",
      "vmdk_name": "magma-fedora25-vmware",
      "output_directory": "output/magma-fedora25-vmware",
      "boot_wait": "20s",
      "boot_command": [
        "<tab> ",
        "inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/magma.fedora25.vagrant.ks ",
        "biosdevname=0 ",
        "net.ifnames=0 ",
        "<enter>"
      ],
      "disk_size": 32768,
      "disk_type_id": "0",
      "vmx_data": {
            "memsize": "2048",
            "numvcpus": "2",
            "cpuid.coresPerSocket": "1"
      },
      "guest_os_type": "fedora-64",
      "skip_compaction": false,
      "http_directory": "http",
      "headless": true,
      "iso_url": "https://mirrors.kernel.org/fedora/releases/25/Server/x86_64/iso/Fedora-Server-netinst-x86_64-25-1.3.iso",
      "iso_checksum": "86bc3694f4938382753d1e9536f2140a6c9c1978207766340c679a89509073c7",
      "iso_checksum_type": "sha256",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
      "tools_upload_flavor": "linux"

    },
    {
      "type": "vmware-iso",
      "name": "magma-debian8-vmware",
      "vm_name": "magma-debian8-vmware",
      "vmdk_name": "magma-debian8-vmware",
      "output_directory": "output/magma-debian8-vmware",
      "boot_wait": "20s",
      "boot_command": [
        "<esc><wait>",
        "auto ",
        "preseed/url=http://{{.HTTPIP}}:{{.HTTPPort}}/magma.debian8.vagrant.cfg ",
        "<enter>"
      ],
      "disk_size": 32768,
      "disk_type_id": "0",
      "vmx_data": {
            "memsize": "2048",
            "numvcpus": "2",
            "cpuid.coresPerSocket": "1"
      },
      "guest_os_type": "debian8-64",
      "skip_compaction": false,
      "http_directory": "http",
      "headless": true,
      "iso_url": "https://mirrors.kernel.org/debian-cd/8.6.0/amd64/iso-cd/debian-8.6.0-amd64-netinst.iso",
      "iso_checksum": "9479c5c2df72ae3878116c43fb42eefae53d1fe363ce514a6afc8289064b9f5f",
      "iso_checksum_type": "sha256",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
      "tools_upload_flavor": "linux"

    },
    {
      "type": "vmware-iso",
      "name": "magma-ubuntu1604-vmware",
      "vm_name": "magma-ubuntu1604-vmware",
      "vmdk_name": "magma-ubuntu1604-vmware",
      "output_directory": "output/magma-ubuntu1604-vmware",
      "boot_wait": "20s",
      "boot_command": [
        "<enter><wait>",
        "<f6><esc>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs>",
        "/install/vmlinuz ",
        "initrd=/install/initrd.gz ",
        "auto-install/enable=true ",
        "debconf/priority=critical ",
        "preseed/url=http://{{.HTTPIP}}:{{.HTTPPort}}/magma.ubuntu1604.vagrant.cfg<wait> ",
        "<enter>"
      ],
      "disk_size": 32768,
      "disk_type_id": "0",
      "vmx_data": {
            "memsize": "2048",
            "numvcpus": "2",
            "cpuid.coresPerSocket": "1"
      },
      "guest_os_type": "ubuntu-64",
      "skip_compaction": false,
      "http_directory": "http",
      "headless": true,
      "iso_url": "https://mirrors.kernel.org/ubuntu-releases/16.04/ubuntu-16.04.1-server-amd64.iso",
      "iso_checksum": "29a8b9009509b39d542ecb229787cdf48f05e739a932289de9e9858d7c487c80",
      "iso_checksum_type": "sha256",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
      "tools_upload_flavor": "linux"

    },
    {
      "type": "vmware-iso",
      "name": "magma-ubuntu1610-vmware",
      "vm_name": "magma-ubuntu1610-vmware",
      "vmdk_name": "magma-ubuntu1610-vmware",
      "output_directory": "output/magma-ubuntu1610-vmware",
      "boot_wait": "20s",
      "boot_command": [
        "<esc><wait>",
        "<esc><wait>",
        "<enter><wait>",
        "/install/vmlinuz ",
        "initrd=/install/initrd.gz ",
        "auto-install/enable=true ",
        "debconf/priority=critical ",
        "preseed/url=http://{{.HTTPIP}}:{{.HTTPPort}}/magma.ubuntu1610.vagrant.cfg<wait> ",
        "<enter>"
      ],
      "disk_size": 32768,
      "disk_type_id": "0",
      "vmx_data": {
            "memsize": "2048",
            "numvcpus": "2",
            "cpuid.coresPerSocket": "1"
      },
      "guest_os_type": "ubuntu-64",
      "skip_compaction": false,
      "http_directory": "http",
      "headless": true,
      "iso_url": "https://mirrors.kernel.org/ubuntu-releases/16.10/ubuntu-16.10-server-amd64.iso",
      "iso_checksum": "72b0d421da77f1e0c549b4efe6fc6c184e9909d6792f0d1e59b56d63e9705659",
      "iso_checksum_type": "sha256",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
      "tools_upload_flavor": "linux"

    }
  ],
  "post-processors": [
    [
      {
        "type": "vagrant",
        "compression_level": 9,
        "keep_input_artifact": false,
        "vagrantfile_template": "tpl/vagrantfile.tpl",
        "output": "output/{{build_name}}-{{user `box_version`}}.box"
      },
      {
          "type": "atlas",
          "only": ["magma-arch-vmware"],
          "artifact": "lavabit/magma-arch",
          "artifact_type": "vagrant.box",
          "metadata": {
              "provider": "vmware_desktop",
              "version": "{{user `box_version`}}",
              "created_at": "{{timestamp}}",
              "description": "The magma encrypted mail daemon build environment."
          }
      },
      {
          "type": "atlas",
          "only": ["magma-gentoo-vmware"],
          "artifact": "lavabit/magma-gentoo",
          "artifact_type": "vagrant.box",
          "metadata": {
              "provider": "vmware_desktop",
              "version": "{{user `box_version`}}",
              "created_at": "{{timestamp}}",
              "description": "The magma encrypted mail daemon build environment."
          }
      },
      {
          "type": "atlas",
          "only": ["magma-debian8-vmware"],
          "artifact": "lavabit/magma-debian",
          "artifact_type": "vagrant.box",
          "metadata": {
              "provider": "vmware_desktop",
              "version": "{{user `box_version`}}",
              "created_at": "{{timestamp}}",
              "description": "The magma encrypted mail daemon build environment."
          }
      },
      {
          "type": "atlas",
          "only": ["magma-fedora25-vmware"],
          "artifact": "lavabit/magma-fedora",
          "artifact_type": "vagrant.box",
          "metadata": {
              "provider": "vmware_desktop",
              "version": "{{user `box_version`}}",
              "created_at": "{{timestamp}}",
              "description": "The magma encrypted mail daemon build environment."
          }
      },
      {
          "type": "atlas",
          "only": ["magma-freebsd11-vmware"],
          "artifact": "lavabit/magma-freebsd",
          "artifact_type": "vagrant.box",
          "metadata": {
              "provider": "vmware_desktop",
              "version": "{{user `box_version`}}",
              "created_at": "{{timestamp}}",
              "description": "The magma encrypted mail daemon build environment."
          }
      },
      {
          "type": "atlas",
          "only": ["magma-openbsd6-vmware"],
          "artifact": "lavabit/magma-openbsd",
          "artifact_type": "vagrant.box",
          "metadata": {
              "provider": "vmware_desktop",
              "version": "{{user `box_version`}}",
              "created_at": "{{timestamp}}",
              "description": "The magma encrypted mail daemon build environment."
          }
      },
      {
          "type": "atlas",
          "only": ["magma-ubuntu1604-vmware"],
          "artifact": "lavabit/magma-ubuntu",
          "artifact_type": "vagrant.box",
          "metadata": {
              "provider": "vmware_desktop",
              "version": "{{user `box_version`}}",
              "created_at": "{{timestamp}}",
              "description": "The magma encrypted mail daemon build environment."
          }
      },
      {
          "type": "atlas",
          "only": ["magma-ubuntu1610-vmware"],
          "artifact": "lavabit/magma-ubuntu-yakkety",
          "artifact_type": "vagrant.box",
          "metadata": {
              "provider": "vmware_desktop",
              "version": "{{user `box_version`}}",
              "created_at": "{{timestamp}}",
              "description": "The magma encrypted mail daemon build environment."
          }
      },
      {
        "type": "artifice",
        "keep_input_artifact": true,
        "files": ["output/{{build_name}}-{{user `box_version`}}.box"]
      },
      {
        "type": "checksum",
        "checksum_types": ["sha256"],
        "keep_input_artifact": true,
        "output": "output/{{build_name}}-{{user `box_version`}}.box.sha256"
      }
    ]
  ]
}
